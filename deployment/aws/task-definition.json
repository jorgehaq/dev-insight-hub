{
    "family": "devinsighthub",
    "networkMode": "awsvpc",
    "executionRoleArn": "arn:aws:iam::${AWS_ACCOUNT_ID}:role/ecsTaskExecutionRole",
    "taskRoleArn": "arn:aws:iam::${AWS_ACCOUNT_ID}:role/ecsTaskRole",
    "containerDefinitions": [
      {
        "name": "devinsighthub-backend",
        "image": "${ECR_REPOSITORY_URI}:latest",
        "essential": true,
        "portMappings": [
          {
            "containerPort": 8000,
            "hostPort": 8000,
            "protocol": "tcp"
          }
        ],
        "environment": [
          {
            "name": "POSTGRES_USER",
            "value": "${POSTGRES_USER}"
          },
          {
            "name": "POSTGRES_PASSWORD",
            "value": "${POSTGRES_PASSWORD}"
          },
          {
            "name": "POSTGRES_DB",
            "value": "${POSTGRES_DB}"
          },
          {
            "name": "POSTGRES_HOST",
            "value": "${RDS_ENDPOINT}"
          },
          {
            "name": "MONGODB_URI",
            "value": "${MONGODB_URI}"
          },
          {
            "name": "REDIS_HOST",
            "value": "${REDIS_HOST}"
          },
          {
            "name": "SECRET_KEY",
            "value": "${SECRET_KEY}"
          },
          {
            "name": "CORS_ORIGINS",
            "value": "${CORS_ORIGINS}"
          },
          {
            "name": "AWS_REGION",
            "value": "${AWS_REGION}"
          },
          {
            "name": "AWS_S3_BUCKET",
            "value": "${S3_BUCKET}"
          },
          {
            "name": "GITHUB_APP_ID",
            "value": "${GITHUB_APP_ID}"
          }
        ],
        "secrets": [
          {
            "name": "AWS_ACCESS_KEY_ID",
            "valueFrom": "arn:aws:ssm:${AWS_REGION}:${AWS_ACCOUNT_ID}:parameter/devinsighthub/aws-access-key-id"
          },
          {
            "name": "AWS_SECRET_ACCESS_KEY",
            "valueFrom": "arn:aws:ssm:${AWS_REGION}:${AWS_ACCOUNT_ID}:parameter/devinsighthub/aws-secret-access-key"
          },
          {
            "name": "GITHUB_APP_PRIVATE_KEY",
            "valueFrom": "arn:aws:ssm:${AWS_REGION}:${AWS_ACCOUNT_ID}:parameter/devinsighthub/github-app-private-key"
          },
          {
            "name": "GITHUB_WEBHOOK_SECRET",
            "valueFrom": "arn:aws:ssm:${AWS_REGION}:${AWS_ACCOUNT_ID}:parameter/devinsighthub/github-webhook-secret"
          }
        ],
        "logConfiguration": {
          "logDriver": "awslogs",
          "options": {
            "awslogs-group": "/ecs/devinsighthub",
            "awslogs-region": "${AWS_REGION}",
            "awslogs-stream-prefix": "backend"
          }
        },
        "healthCheck": {
          "command": [
            "CMD-SHELL",
            "curl -f http://localhost:8000/api/health || exit 1"
          ],
          "interval": 30,
          "timeout": 5,
          "retries": 3,
          "startPeriod": 60
        },
        "cpu": 512,
        "memoryReservation": 1024,
        "essential": true
      },
      {
        "name": "devinsighthub-worker",
        "image": "${ECR_REPOSITORY_URI}:latest",
        "essential": true,
        "command": ["celery", "-A", "app.worker.celery", "worker", "--loglevel=info"],
        "environment": [
          {
            "name": "POSTGRES_USER",
            "value": "${POSTGRES_USER}"
          },
          {
            "name": "POSTGRES_PASSWORD",
            "value": "${POSTGRES_PASSWORD}"
          },
          {
            "name": "POSTGRES_DB",
            "value": "${POSTGRES_DB}"
          },
          {
            "name": "POSTGRES_HOST",
            "value": "${RDS_ENDPOINT}"
          },
          {
            "name": "MONGODB_URI",
            "value": "${MONGODB_URI}"
          },
          {
            "name": "REDIS_HOST",
            "value": "${REDIS_HOST}"
          },
          {
            "name": "AWS_REGION",
            "value": "${AWS_REGION}"
          },
          {
            "name": "AWS_S3_BUCKET",
            "value": "${S3_BUCKET}"
          }
        ],
        "secrets": [
          {
            "name": "AWS_ACCESS_KEY_ID",
            "valueFrom": "arn:aws:ssm:${AWS_REGION}:${AWS_ACCOUNT_ID}:parameter/devinsighthub/aws-access-key-id"
          },
          {
            "name": "AWS_SECRET_ACCESS_KEY",
            "valueFrom": "arn:aws:ssm:${AWS_REGION}:${AWS_ACCOUNT_ID}:parameter/devinsighthub/aws-secret-access-key"
          }
        ],
        "logConfiguration": {
          "logDriver": "awslogs",
          "options": {
            "awslogs-group": "/ecs/devinsighthub",
            "awslogs-region": "${AWS_REGION}",
            "awslogs-stream-prefix": "worker"
          }
        },
        "cpu": 256,
        "memoryReservation": 512,
        "essential": false
      }
    ],
    "requiresCompatibilities": [
      "FARGATE"
    ],
    "cpu": "1024",
    "memory": "2048",
    "tags": [
      {
        "key": "Project",
        "value": "DevInsightHub"
      },
      {
        "key": "Environment",
        "value": "${ENVIRONMENT}"
      }
    ]
  }